#!/usr/bin/env ruby

story_url_base = "https://apoexab.tpondemand.com/entity"
story_url_pattern = /#{story_url_base}\/(\d+)/
story_regex = /^(\d+)-(.*)/
fv_regex = /^fv-(.*)/
branch = `git rev-parse --abbrev-ref HEAD`
pr_templates_paths = %w[
  .github/PULL_REQUEST_TEMPLATE.md
]

def titleize(str)
  str.tr("-", " ").capitalize
end

case branch
when story_regex
  story_id = $1
  story_url = story_url_base + "/" + story_id
  title = "[#{story_id}] #{titleize($2)}"
when fv_regex
  story_url = ""
  title = "[FV] #{titleize($1)}"
else
  story_url = ""
  title = titleize(branch)
end

message = if (file = pr_templates_paths.find { |p| File.exist?(p) })
  <<~MESS
  #{title}

  #{File.read(file).gsub(story_url_pattern, story_url)}
  MESS
else
  <<~MESS
  #{title}

  #{story_url}
  MESS
end

puts message
